name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  code-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm ci --prefer-offline --no-audit --no-fund
      - run: npm run format:check

  types-compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm ci --prefer-offline --no-audit --no-fund
      - run: npm run types:check

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm ci --prefer-offline --no-audit --no-fund
      - run: npm run tests

  verify-commit-msg:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm ci --prefer-offline --no-audit --no-fund

      - name: Lint commit messages
        run: npx tsx tools/commit-linter.ts check origin/main --ci
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  deploy:
    needs: [code-format, types-compile, run-tests, verify-commit-msg]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: 'https://registry.npmjs.org/'
      - run: npm --version
      - run: node --version
      - run: npm ci --prefer-offline --no-audit --no-fund
      - run: npm run build
      - name: Check if version is published
        id: check_version
        run: |
          set -euo pipefail

          VERSION=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")

          echo "Checking $PKG_NAME@$VERSION"

          if npm view "$PKG_NAME@$VERSION" version > /dev/null 2>&1; then
            echo "published_version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "published_version=" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish if not published
        if: steps.check_version.outputs.published_version == ''
        run: npm publish --provenance --access public
