name: Lint

on:
  push:
    branches: ['**']
  pull_request:

jobs:
  code-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 23
      - run: npm ci
      - run: npm run format:check

  types-compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 23
      - run: npm ci
      - run: npm run types:check

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 23
      - run: npm ci
      - run: npm run tests

  deploy:
    needs: [code-format, types-compile, run-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 23
          registry-url: 'https://registry.npmjs.org/'
      - run: npm ci
      - run: npm run build
      - name: Check if version is published
        id: check_version
        run: |
          set -euo pipefail

          VERSION=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")

          echo "Checking $PKG_NAME@$VERSION"

          if npm view "$PKG_NAME@$VERSION" version > /dev/null 2>&1; then
            echo "published_version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "published_version=" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish if not published
        if: steps.check_version.outputs.published_version == ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public
